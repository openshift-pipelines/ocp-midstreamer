name: Streamstress Run

on:
  workflow_dispatch:
    inputs:
      cluster_api_url:
        description: 'OCP cluster API URL (e.g. https://api.cluster.example.com:6443)'
        required: true
        type: string
      cluster_password:
        description: 'kubeadmin password'
        required: true
        type: string
      components:
        description: 'Components to test (e.g. pipeline, pipeline:v0.60.0,triggers)'
        required: false
        default: 'pipeline'
        type: string
      release_tests_ref:
        description: 'release-tests git ref'
        required: false
        default: 'master'
        type: string
      cli_flags:
        description: 'Extra CLI flags (e.g. --as-of 2026-01-15, --profile)'
        required: false
        default: ''
        type: string
      image_tag:
        description: 'Container image tag (default: latest)'
        required: false
        default: 'latest'
        type: string

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Mask credentials
        run: |
          CLUSTER_PASSWORD=$(jq -r '.inputs.cluster_password' "$GITHUB_EVENT_PATH")
          echo "::add-mask::$CLUSTER_PASSWORD"
          echo "CLUSTER_PASSWORD=$CLUSTER_PASSWORD" >> "$GITHUB_ENV"

      - name: Install oc
        uses: redhat-actions/openshift-tools-installer@v1
        with:
          source: mirror
          oc: '4'

      - name: Login to OCP cluster
        env:
          CLUSTER_API_URL: ${{ inputs.cluster_api_url }}
        run: |
          set -euo pipefail
          oc login "$CLUSTER_API_URL" \
            -u cluster-admin \
            -p "$CLUSTER_PASSWORD" \
            --insecure-skip-tls-verify
          echo "Logged in as: $(oc whoami)"
          echo "Server: $(oc whoami --show-server)"

      - name: Setup cluster prerequisites
        run: |
          set -euo pipefail
          NS="openshift-pipelines"

          # Patch imageregistry for default route
          oc patch configs.imageregistry.operator.openshift.io/cluster \
            --type merge -p '{"spec":{"defaultRoute":true}}' 2>/dev/null || true

          # Ensure namespace exists
          oc get namespace "$NS" 2>/dev/null || oc create namespace "$NS"

          # Create ServiceAccount
          oc apply -f - <<EOF
          apiVersion: v1
          kind: ServiceAccount
          metadata:
            name: streamstress-sa
            namespace: $NS
          EOF

          # Create ClusterRoleBinding
          oc apply -f - <<EOF
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: streamstress-crb
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: cluster-admin
          subjects:
            - kind: ServiceAccount
              name: streamstress-sa
              namespace: $NS
          EOF

          echo "Cluster prerequisites configured."

      - name: Create streamstress Job
        env:
          IMAGE_TAG: ${{ inputs.image_tag }}
          COMPONENTS: ${{ inputs.components }}
          RELEASE_TESTS_REF: ${{ inputs.release_tests_ref }}
          CLI_FLAGS: ${{ inputs.cli_flags }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          NS="openshift-pipelines"
          JOB_NAME="streamstress-$(date +%s)"
          IMAGE="ghcr.io/openshift-pipelines/streamstress:${IMAGE_TAG}"
          RUN_LABEL="CI run: ${COMPONENTS}"

          # Build CLI args for the Job container
          # The entrypoint.sh wrapper will invoke streamstress with these args,
          # then auto-publish results to gh-pages if GITHUB_TOKEN is set.
          CLI_ARGS="run --components ${COMPONENTS} --release-tests-ref ${RELEASE_TESTS_REF} --skip-build --output-dir /test-output"
          if [ -n "$CLI_FLAGS" ]; then
            CLI_ARGS="${CLI_ARGS} ${CLI_FLAGS}"
          fi

          # Convert CLI_ARGS string to JSON array for Job spec
          ARGS_JSON="["
          first=true
          for arg in $CLI_ARGS; do
            if [ "$first" = true ]; then
              ARGS_JSON="${ARGS_JSON}\"${arg}\""
              first=false
            else
              ARGS_JSON="${ARGS_JSON},\"${arg}\""
            fi
          done
          ARGS_JSON="${ARGS_JSON}]"

          oc apply -f - <<EOF
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: ${JOB_NAME}
            namespace: ${NS}
            labels:
              app: streamstress
          spec:
            backoffLimit: 0
            activeDeadlineSeconds: 10800
            template:
              metadata:
                labels:
                  app: streamstress
                  job-name: ${JOB_NAME}
              spec:
                serviceAccountName: streamstress-sa
                restartPolicy: Never
                containers:
                  - name: streamstress
                    image: ${IMAGE}
                    imagePullPolicy: Always
                    args: ${ARGS_JSON}
                    env:
                      - name: JOB_NAME
                        value: "${JOB_NAME}"
                      - name: GITHUB_TOKEN
                        value: "${GITHUB_TOKEN}"
                      - name: GITHUB_REPOSITORY
                        value: "${GITHUB_REPOSITORY}"
                      - name: RUN_LABEL
                        value: "${RUN_LABEL}"
                      - name: OUTPUT_DIR
                        value: "/test-output"
          EOF

          echo "JOB_NAME=$JOB_NAME" >> "$GITHUB_ENV"
          echo "IMAGE=$IMAGE" >> "$GITHUB_ENV"

          # Verify the Job was created and pod is starting
          echo "Waiting for Job pod to appear..."
          for i in $(seq 1 30); do
            POD=$(oc get pods -n "$NS" -l "job-name=$JOB_NAME" -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || true)
            if [ -n "$POD" ]; then
              PHASE=$(oc get pod "$POD" -n "$NS" -o jsonpath='{.status.phase}' 2>/dev/null || echo "Unknown")
              echo "Pod: $POD (phase: $PHASE)"
              break
            fi
            sleep 2
          done

      - name: Write step summary
        env:
          CLUSTER_URL: ${{ inputs.cluster_api_url }}
          COMPONENTS: ${{ inputs.components }}
          IMAGE_TAG: ${{ inputs.image_tag }}
        run: |
          PAGES_URL="https://${GITHUB_REPOSITORY_OWNER}.github.io/${GITHUB_REPOSITORY#*/}/"
          echo "## Streamstress Job Launched" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Job:** \`$JOB_NAME\`" >> "$GITHUB_STEP_SUMMARY"
          echo "**Image:** \`$IMAGE\`" >> "$GITHUB_STEP_SUMMARY"
          echo "**Components:** $COMPONENTS" >> "$GITHUB_STEP_SUMMARY"
          echo "**Cluster:** $CLUSTER_URL" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### What Happens Next" >> "$GITHUB_STEP_SUMMARY"
          echo "1. Tests run in-cluster (~2.5 hrs)" >> "$GITHUB_STEP_SUMMARY"
          echo "2. When complete, Job auto-publishes results to gh-pages" >> "$GITHUB_STEP_SUMMARY"
          echo "3. Results appear on [Dashboard]($PAGES_URL)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### View Logs" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "oc logs -f job/$JOB_NAME -n openshift-pipelines" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
